# 高并发：从一次 Agoda 系统设计面试中的收获

分享一个我在应聘 Senior Full Stack Engineer 职位时的面试经历。由于我的英语口语有限，这次面试对我来说是一次相当大的挑战。

当我走进面试室的时候，我就意识到这是一次具有挑战性的机会。这是第二轮面试。

在我参与 Agoda 高级全栈职位的面试过程中，我充分意识到前方的道路将是严峻而复杂的。这个职位对前端和后端技术的深度和广度强调非常重要，意味着面试过程自然会在复杂性和设计期望方面逐渐提升。

本篇文章深入探讨了我在高级全栈面试中的沉浸式经验，分享了我在技术要求方面的深度认识，以及塑造了这次面试的复杂设计方面的见解。在这个过程中，不仅仅是对我的技术熟练程度进行了考验，也突显了在高级岗位上全面专业知识的重要性。

但重要的是，我的英语口语表现不够出色，这让我失去了这个职位的机会。下一步需要不仅仅是磨练我的技术，还需要集中精力提升我的沟通能力和软性技能。

## 面试流程

**任务 1：** 这是一个相对简单的前端任务，主要涉及 React 的基础知识，包括 useState、useEffect 和防抖。我认为这个任务对我来说相对轻松。

**任务 2：** 高并发系统设计：如何展示和存储用户数量？特别是在同时有 100 万用户和 20 万用户访问产品详情页面的情况下。如何设计前后端来在详情页面中显示这个数字。

在我面对这个问题时，我意识到设计一个处理如此高并发的系统是一个复杂的任务，需要对各个方面进行仔细的考虑。

因此，我从两个方面提出了以下解决方案：

**1. 前端：**

在前端，关键是为用户提供关于当前浏览产品详情页面人数的实时更新。为了实现这一点，我提出了两种策略：

- **CDN 静态资源：** 将所有资源放在 CDN 中，如 js、css、图像等。这可以减轻服务器的压力，提高用户体验。如果我们想要减小资源的大小，还可以使用雪碧图来合并图像。但这只是提高网站性能的简单方法，不是关键点。
- **WebSocket 和 SSE（服务器推送事件）：** 将 http 协议直接升级为 ws 协议。通过实现 ws 协议或 SSE 连接来实现前端和后端之间的实时通信。这确保用户在用户计数发生变化时立即收到更新。

**2. 后端：**

后端是处理用户计数和有效提供实时数据的核心。为了应对高并发挑战，我提出了以下策略：

- **负载均衡和 API 网关：** 使用负载均衡器和 API 网关将传入的流量分发到多个服务器和后端实例。这确保后端可以处理高数量的请求并高效地提供服务，同时避免任何单个组件成为瓶颈。
  - 在 API 网关中设置速率限制，以防止后端被过多的请求压倒。我认为这可以保持后端的稳定性。
- 微服务架构
  - **缓存机制：** 集成内存缓存机制以存储用户计数，比如使用 Redis，可以快速高效地检索计数数据。这可以减轻数据库的负担并提高响应时间。
  - **在与一位朋友讨论后，我了解到 Redis 还支持持久性机制，例如追加日志文件（AOF）和 Redis 数据库（RDB）快照。在服务器故障的情况下，我们可以通过读取日志文件来恢复数据。**
  - **历史数据的数据库：** 直接使用数据库存储历史用户计数数据，以便进行分析并深入了解用户行为趋势。
  - **Restful API + MQ：** 使用 Restful API 和消息队列（MQ）的组合来处理前端请求，与后端服务进行有效的交互，并确保广播更新的异步通信。这种方法有助于处理高并发和大量请求。它还允许在处理请求时进行可扩展性和灵活性。实际上，这是用户计数。
  - **RPC ProtoBuf：** 使用 RPC ProtoBuf 在微服务之间进行通信。但在面试过程中，我忘记了`ProtoBuf`的确切名称，最终只是将其描述为`二进制缓冲协议`。我认为这是一个严重的错误。设置临时数据库来存储 ProtoBuf 数据，同时添加一个标志状态变量来指示是否准备就绪以供消费，或者数据是否已经被消耗，可以增强数据的一致性，并有助于有效管理数据流。**在 RPC 的上下文中添加标志的这种方法通常非常适用于事件驱动的架构。它支持异步通信和灵活性。标志状态特别适用于同时发生多个操作的场景。它可以表示各种状态，比如`准备就绪`、`处理中`、`已消耗`。**

## 忽视的问题

总结起来，你的回答展示了一个坚实的基础，但由于没有涉及到以下关键方面，你的解决方案还不够深入。通过在解释中加入这些考虑因素，你将提供一个更全面和周到的解决方案，从而展示你解决高并发系统设计方面的复杂问题的能力。

1. **确保数据一致性和并发操作的正确性。** 需要详细解释锁、事务和隔离级别等机制，以应对这些挑战，进一步强化我的论据。
2. **全面考虑负载均衡算法、缓存策略、API 设计和消息队列的选择。** 详细介绍不同的负载均衡算法，讨论缓存驱逐策略，详述 RESTful API 设计原则，并比较不同的消息队列选项，将展示出更深入的系统设计细节理解。
3. **在高并发情况下管理 WebSocket 连接和资源。** 没有详细阐述如何在高并发期间有效管理 WebSocket 连接和处理资源利用率。讨论连接池、限流和资源监控等技术，可以突显出处理实际挑战的能力。

# 总结

最终，我认为在面试中表现得不够出色。因此，我仍然需要提升我的口语表达能力。我还需要更多地学习有关系统设计的知识。我认为这是提升解决问题能力的良好途径。
